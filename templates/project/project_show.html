{% extends "index.html" %}
{% load static %}
{% load tags %}
{% block extra-css %}
    <link rel="stylesheet" type="text/css" href="{% static 'assets/plugins/wizard/steps.css' %}">
    <style>
        .progress li {
            list-style: none;
            float: left;
            margin-left: 192px;
        }

        .progress .name li {
            list-style: none;
            float: left;
            margin-left: 146px;
        }

        .pro1 .progress-bar {
            width: 50%;
        }

        .pro2 .progress-bar {
            width: 73%;
        }

        .pro3 .progress-bar {
            width: 100%;
        }

        .style-spa {
            border: 3.8px solid #26dad2;
            border-radius: 10px;
            background: #26dad2;
        }

        .style-spa1 {
            border: 3.8px solid #26dad2;
            border-radius: 10px;
            background: #fff;
        }

        .style-spa2 {
            border: 3.8px solid #e9ecef;
            border-radius: 10px;
            background: #e9ecef;
        }

        .name span {
            font-size: 16px;
        }

        label {
            font-weight: bold;
        }

        .profile-tab li a.nav-link.active {
            border: 0;
            color: #67757c;
        }

        .table thead th, .table td {
            padding: 1.35rem 0.75rem;
            font-weight: 300;
        }

        .time th, .time td {
            padding-right: 10px;
            padding-bottom: 10px;
        }


    </style>
{% endblock %}
{% block wrapper %}
    <div class="row page-titles">
        <div class="col-md-5 align-self-center">
            <h3 class="text-themecolor">项目查看-{% if project.tag == 0 %}内部{% elif project.tag == 1 %}
                外部{% endif %}</h3>
        </div>
        <div class="col-md-7 align-self-center">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'index' %}">首页</a></li>
                <li class="breadcrumb-item">项目</li>
                {% if project.status == 0 %}
                    <li class="breadcrumb-item"><a href="{% url 'project' %}?sta=0">待审核项目</a></li>
                {% elif project.status == 1 or project.status == 2 or project.status == 5 %}
                    <li class="breadcrumb-item"><a href="{% url 'project' %}?sta=1">执行项目</a></li>
                {% else %}
                    <li class="breadcrumb-item"><a href="{% url 'project' %}?sta=3">历史项目</a></li>
                {% endif %}
                <li class="breadcrumb-item active">{{ project.project_name }}</li>
            </ol>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body" style="padding:1.2rem 3.3rem;">
                        {% if project.examined != 2 %}
                            <div class="form-body"
                                 style="margin-top: 68px;border-bottom: 1px solid #f0f0f0;">
                                <div class="progress {% if project.examined == 2 %}
                            pro3
                            {% else %}
                            {% if examine.examine == 0 %}
                            pro1
                            {% elif examine.examine == 1 %}
                            pro2
                            {% endif %}
                            {% endif %}" style="width: 940px;height:8px;border-radius:6px;margin-left: 12px;">
                                    <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0"
                                         aria-valuemax="100" style="background-color: #26dad2;border-radius: 4px;">
                                        <span class="sr-only">60% Complete</span>
                                        <div style="position: absolute" class="yuan">
                                            <ul style="margin-left: -93px">
                                                <li>
                                                <span style="display: block;width: 18px;height: 18px;z-index:  100;"
                                                      class="style-spa"></span>
                                                </li>
                                                <li>
                                                <span style="display: block;width: 18px;height: 18px;z-index:  100;"
                                                      class="{% if examine.examine == 0 %}
                             style-spa1{% else %}style-spa{% endif %}"></span>
                                                </li>
                                                <li>
                                                <span style="display: block;width: 18px;height: 18px;z-index:  100;"
                                                      class="{% if project.examined == 2 %}
                            style-spa
                            {% else %}
                            {% if examine.examine == 0 %}
                            style-spa2
                            {% elif examine.examine == 1 %}
                            style-spa1
                            {% endif %}
                            {% endif %}"></span>
                                                </li>
                                                <li>
                                                <span style="display: block;width: 18px;height: 18px;z-index:  100;"
                                                      class="{% if project.examined == 2 %}
                            style-spa
                            {% else %}
                            style-spa2
                            {% endif %}"></span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div style="position: absolute;top: 45px;margin-left: -73px;" class="name">
                                        <ul>
                                            <li>
                                                <span>提交申请</span>
                                            </li>
                                            <li>
                                                <span>经理审核</span>
                                            </li>
                                            <li>
                                                <span>管理审核</span>
                                            </li>
                                            <li>
                                                <span>审核完成</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="row" style="margin-top: 50px;">
                                    <div class="col-md-5">
                                        <div class="form-group row">
                                            <label class="control-label col-md-2">审核状态</label>
                                            <div class="col-md-10">
                                                {% if examine.is_pass == None %}
                                                    <span class="label label-warning">审核中</span>
                                                {% elif examine.is_pass == False %}
                                                    <span class="label label-danger">已拒绝</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-5" style="z-index: -1">
                                        <div class="form-group row">
                                        </div>
                                    </div>
                                </div>
                                {% if examine.is_pass == False %}
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div class="form-group row">
                                                <label class="control-label col-md-2">审核说明</label>
                                                <div class="col-md-10">
                                            <span>
                                                {{ examine.description }}
                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-5" style="z-index: -1">
                                            <div class="form-group row">
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        <div class="form-body" style="margin-top: 30px">
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">项目名称</label>
                                        <div class="col-md-10">
                                            <span>{{ project.project_name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">所属部门</label>
                                        <div class="col-md-10">
                                            <span>{{ project.department }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">项目类型</label>
                                        <div class="col-md-10">
                                            <span>{{ project.project_type }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">流程选择</label>
                                        <div class="col-md-10">
                                            <span>{{ project.flow }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if project.tag == 1 %}
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="form-group row">
                                            <label class="control-label col-md-2">合同编号</label>
                                            <div class="col-md-10">
                                                <span>{{ project.contract_no }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-5" style="z-index: -1">
                                        <div class="form-group row">
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">项目描述</label>
                                        <div class="col-md-10">
                                            <span>{{ project.priject_description }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5" style="z-index: -1">
                                    <div class="form-group row">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">项目托付</label>
                                        <div class="col-md-10" style="white-space: nowrap;">
                                        <span>
                                            {% for user in project_user %}
                                                {{ user.user }},
                                            {% endfor %}
                                        </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5" style="z-index: -1">
                                    <div class="form-group row">
                                    </div>
                                </div>
                            </div>
                            {% if project.examined == 2 %}
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="form-group row">
                                            <label class="control-label col-md-2">流程节点</label>
                                            <div class="col-md-10" style="white-space: nowrap;">
                                        <span>
                                            {{ project.node }}
                                            {% if project.node_node %}
                                                -->{{ project.node_node }}
                                            {% endif %}
                                        </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-5" style="z-index: -1">
                                        <div class="form-group row">
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">开始时间</label>
                                        <div class="col-md-10">
                                            <span>{{ project.start_time }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5" style="z-index: -1">
                                    <div class="form-group row">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">结束时间</label>
                                        <div class="col-md-10">
                                            <span>{{ project.end_time }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5" style="z-index: -1">
                                    <div class="form-group row">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row" style="margin-bottom: 15px;">
                                        <label class="control-label col-md-2">上传附件</label>
                                        <div class="col-md-10">
                                            {% if project_file %}
                                                {% for file in project_file %}
                                                    <div class="row" style="margin-bottom: 18px">
                                                        <div class="col-md-7">
                                                            <span style="margin-bottom: 18px">{{ file.file.name }}</span>
                                                        </div>
                                                        <div class="col-md-3"><a href="/media/{{ file.file.file }}"
                                                                                 download="{{ file.file.name }}">下载</a>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <span>None</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5" style="z-index: -1">
                                    <div class="form-group row">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group row">
                                        <label class="control-label col-md-2">项目状态</label>
                                        <div class="col-md-10">
                                            <span>{{ project.get_status_display }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5" style="z-index: -1">
                                    <div class="form-group row">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group " style="margin-bottom: 6px">
                                        <label>项目节点</label>
                                    </div>
                                    <div class="education_fields">
                                        {% if project_nodes %}
                                            <table class="table" style="margin-bottom: 25px;margin-left: -12px;">
                                                <thead>
                                                <tr>
                                                    <th>节点名称</th>
                                                    <th>流程节点</th>
                                                    <th>子节点</th>
                                                    <th>时间</th>
                                                    <th>数量</th>
                                                    <th>单位</th>
                                                    <th>提醒时间</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for node in project_nodes %}
                                                    <tr>
                                                        <td>{{ node.name }}</td>
                                                        <td>{% if node.node %}
                                                            {{ node.node }}{% endif %}</td>
                                                        <td>{% if node.node_node %}
                                                            {{ node.node_node }}{% endif %}</td>
                                                        <td>{{ node.time|date:"Y-m-d" }} {{ node.time|time:"H:i" }}</td>
                                                        <td>{{ node.number }}</td>
                                                        <td>{{ node.unit }}</td>
                                                        <td>{% if node.node_alert_time %}
                                                            {{ node.node_alert_time|date:"Y-m-d" }}
                                                            {{ node.time|time:"H:i" }}{% endif %}</td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        {% endif %}
                                    </div>
                                    <form class="form-horizontal" method="POST">
                                        {{ error }}
                                        {% csrf_token %}
                                        <input hidden name="class" value="stop" id="class">
                                        {% if project.supension_time %}
                                            <input hidden name="supension_time" value="{{ project.supension_time }}">
                                            <div class="row time" style="display: none">
                                                <div class="col-md-6">
                                                    <div class="form-group example">
                                                        <label>结束时间</label>
                                                        <div class="input-group">
                                                            <div class="input-daterange input-group"
                                                                 id="date-range">
                                                                <input type="text" class="form-control"
                                                                       name="end_time"
                                                                       id="id_end_time"
                                                                       value="{{ project.end_time|date:"Y-m-d H:i" }}">
                                                                <div class="input-group-append">
                                                            <span class="input-group-text">
                                                                <i class="icon-calender"></i></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group row">
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="row time" style="display: none">
                                                <div class="col-md-6">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group example">
                                                                <label>开始时间</label>
                                                                <div class="input-group">
                                                                    <div class="input-daterange input-group"
                                                                         id="date-range">
                                                                        <input type="text" class="form-control"
                                                                               name="start_time"
                                                                               id="id_start_time"
                                                                               value="">
                                                                        <div class="input-group-append">
                                                            <span class="input-group-text">
                                                                <i class="icon-calender"></i></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group example">
                                                                <label>结束时间</label>
                                                                <div class="input-group">
                                                                    <div class="input-daterange input-group"
                                                                         id="date-range">
                                                                        <input type="text" class="form-control"
                                                                               name="end_time"
                                                                               id="id_end_time"
                                                                               value="{{ project.end_time|date:"Y-m-d H:i" }}">
                                                                        <div class="input-group-append">
                                                            <span class="input-group-text">
                                                                <i class="icon-calender"></i></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group row">
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if project_nodes %}
                                            <div class="row time" style="display: none" id="project_node">
                                                <div class="col-md-12">
                                                    <div class="form-group">
                                                        <label>项目节点</label>
                                                    </div>
                                                    <table>
                                                        <thead>
                                                        <tr>
                                                            <th>节点名称</th>
                                                            <th>时间</th>
                                                            <th>提醒时间</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for node in project_nodes %}
                                                            {% if project.supension_time %}
                                                                {% if node.time > project.supension_time %}
                                                                    <tr class="node">
                                                                        <td>
                                                                            <input name="id" hidden
                                                                                   value="{{ node.id }}">
                                                                            <span>{{ node.name }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <input type="text"
                                                                                   class="form-control"
                                                                                   name="time"
                                                                                   id="id_time{{ node.order }}"
                                                                                   placeholder="结束时间"
                                                                                   value="{{ node.time|date:"Y-m-d H:i" }}">
                                                                        </td>
                                                                        <td>
                                                                            <input type="text"
                                                                                   class="form-control node_alert_time"
                                                                                   name="node_alert_time{{ node.order }}"
                                                                                   id="node_alert_time{{ node.order }}"
                                                                                   placeholder="提醒时间"
                                                                                   value="{{ node.node_alert_time|date:"Y-m-d H:i" }}">
                                                                        </td>
                                                                    </tr>
                                                                {% endif %}
                                                            {% else %}
                                                                <tr class="node">
                                                                    <td>
                                                                        <input name="id" hidden
                                                                               value="{{ node.id }}">
                                                                        <span>{{ node.name }}</span>
                                                                    </td>
                                                                    <td>
                                                                        <input type="text"
                                                                               class="form-control"
                                                                               name="time"
                                                                               id="id_time{{ node.order }}"
                                                                               placeholder="结束时间"
                                                                               value="{{ node.time|date:"Y-m-d H:i" }}">
                                                                    </td>
                                                                    <td>
                                                                        <input type="text"
                                                                               class="form-control node_alert_time"
                                                                               name="node_alert_time{{ node.order }}"
                                                                               id="node_alert_time{{ node.order }}"
                                                                               placeholder="提醒时间"
                                                                               value="{{ node.node_alert_time|date:"Y-m-d H:i" }}">
                                                                    </td>
                                                                </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="row no" style="padding-bottom: 20px;display: none">
                                            <div class="col-md-5">
                                                <div class="form-group row">
                                                    <label class="control-label col-md-2">节点</label>
                                                    <div class="col-md-10">
                                                        <select name="node" id="id_node"
                                                                class="form-control custom-select"
                                                                onchange="nodes(this)">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-5" style="z-index: -1">
                                                <div class="form-group row">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row no" style="padding-bottom: 20px;display: none">
                                            <div class="col-md-5">
                                                <div class="form-group row">
                                                    <label class="control-label col-md-2">子节点</label>
                                                    <div class="col-md-10">
                                                        <select name="node_node" id="id_node_node"
                                                                class="form-control custom-select">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-5" style="z-index: -1">
                                                <div class="form-group row">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-actions" style="display: none;margin-bottom: 30px" id="btn1">
                                            <button type="submit" class="btn btn-success">保存
                                            </button>
                                        </div>
                                        <div class="form-actions" id="btn" style="margin-bottom: 30px">
                                            {% show_btn request 'project' project %}
                                            <div id="myModal" class="modal fade in" tabindex="-1" role="dialog"
                                                 aria-labelledby="myModalLabel" aria-hidden="true"
                                                 style="margin: 9rem auto">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h4 class="modal-title" id="myModalLabel">文件上传</h4>
                                                            <button type="button" class="close"
                                                                    data-dismiss="modal" aria-hidden="true">×
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="form-group">
                                                                <label class="col-md-12">所属节点</label>
                                                                <div class="col-md-12">
                                                                    <select name="project_node"
                                                                            id="id_project_node"
                                                                            class="form-control">
                                                                        {% for project_node in project_nodes %}
                                                                            <option value="{{ project_node.id }}">{{ project_node.name }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="col-md-12"></label>
                                                                <div class="col-md-12">
                                                                    <input type="file" id="id_file"
                                                                           multiple="multiple"
                                                                           onchange="upfile(this)"
                                                                           class="form-control">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button"
                                                                    class="btn btn-success waves-effect"
                                                                    data-dismiss="modal" onclick="node_file()">
                                                                保存
                                                            </button>
                                                            <button type="button"
                                                                    class="btn btn-inverse waves-effect"
                                                                    data-dismiss="modal">关闭
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- /.modal-content -->
                                                </div>
                                                <!-- /.modal-dialog -->
                                            </div>
                                            <button type="button" class="btn btn-inverse"
                                                    onclick="window.location.href='{% url "project" %}?sta={% if project.status == 1 or project.status == 2 or project.status == 5 %}1{% elif project.status == 0 %}0{% else %}3{% endif %}'">
                                                返回
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <ul class="nav nav-tabs profile-tab" role="tablist" style="background-color: #f2f2f2;border: 0">
                        <li class="nav-item" style="width: 24.9%"><a class="nav-link active" data-toggle="tab"
                                                                     href="#record" role="tab"
                                                                     style="text-align: center"
                                                                     onclick="tab_change(this)">事件节点</a>
                        </li>
                        <li style="width: 0.1%;background-color: #ffffff"></li>
                        <li class="nav-item" style="width: 24.9%"><a class="nav-link" data-toggle="tab"
                                                                     href="#log" role="tab"
                                                                     style="text-align: center"
                                                                     onclick="tab_change(this)">操作记录</a>
                        </li>
                        <li style="width: 0.1%;background-color: #ffffff"></li>
                        <li class="nav-item" style="width: 24.9%"><a class="nav-link" data-toggle="tab" href="#discuss"
                                                                     role="tab" style="text-align: center"
                                                                     onclick="tab_change(this)">沟通记录</a>
                        </li>
                        <li style="width: 0.1%;background-color: #ffffff"></li>
                        <li class="nav-item" style="width: 24.9%"><a class="nav-link" data-toggle="tab"
                                                                     href="#files"
                                                                     role="tab" style="text-align: center"
                                                                     onclick="tab_change(this)">文件记录</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="record" role="tabpanel">
                            <div class="card-body" style="padding: 1.25rem 3.6rem .6rem">
                                <form class="form-horizontal" method="POST"
                                      enctype="multipart/form-data" style="margin-bottom: 0px">
                                    {% csrf_token %}
                                    <table class="table" style="margin-bottom:0px">
                                        <thead>
                                        <tr>
                                            <th>事件时间</th>
                                            <th>事件记录</th>
                                            <th>创建人</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% if project_records %}
                                            {% for project_record in project_records %}
                                                <tr>
                                                    <td>{{ project_record.time|date:"Y/m/d" }}</td>
                                                    <td>{{ project_record.record }}</td>
                                                    <td>{{ project_record.created_user }}</td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="4" style="text-align: center">无记录</td>
                                            </tr>
                                        {% endif %}
                                        </tbody>
                                    </table>
                                    <div class="form-body" style="border-top: 1px solid #f3f1f1;">
                                        <div class="row" style="padding-top: 25px">
                                            <div class="col-md-5">
                                                <div class="form-group row">
                                                    <label class="control-label col-md-2">事件节点</label>
                                                    <div class="col-md-10">
                                                        <input type="text" class="form-control"
                                                               name="record_time"
                                                               id="id_record_time"
                                                               placeholder="事件时间"
                                                               value="{{ node.time|date:"Y/m/d" }}">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-5" style="z-index: -1">
                                                <div class="form-group row">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-5">
                                                <div class="form-group row">
                                                    <label class="control-label col-md-2"></label>
                                                    <div class="col-md-10">
                                                         <textarea name="record" id="id_record" cols="98" rows="4"
                                                                   maxlength="200" class="form-control"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-5" style="z-index: -1">
                                                <div class="form-group row">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-actions" style="margin-bottom: 30px">
                                            <button type="submit" class="btn btn-success" href="record_end"
                                                    onclick="tab_change(this)">保存
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="tab-pane" id="log" role="tabpanel">
                            <div class="card-body" style="padding: 1.25rem 3.6rem .6rem">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>操作时间</th>
                                        <th>操作记录</th>
                                        <th>操作人</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for project_log in project_logs %}
                                        <tr>
                                            <td>{{ project_log.created_time|date:"Y/m/d H:i" }}</td>
                                            <td>{{ project_log.created_user }}{{ project_log.description }}</td>
                                            <td>{{ project_log.created_user }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane" id="discuss" role="tabpanel">
                            <div class="card-body" style="padding: 1.25rem 3.6rem .6rem">
                                <form class="form-horizontal" method="POST"
                                      enctype="multipart/form-data" style="margin-bottom: 0px">
                                    {% csrf_token %}
                                    <div class="form-body">
                                        {% for project_discuss in project_discusses %}
                                            <div class="row" style="border-bottom: 1px solid #f3f1f1">
                                                <div class="col-md-1" style="max-width: 6.5%;padding-top: 16px">
                                                    <img src="/media/{{ project_discuss.created_user.head }}"
                                                         alt="user" style="width: 45px;border-radius: 100%;">
                                                </div>
                                                <div class="col-md-11" style="padding-left: 0px;padding-top: 16px">
                                                    <div class="row">{{ project_discuss.created_user }}：{{ project_discuss.discuss }}</div>
                                                    {% project_discuss project_discuss %}
                                                    <div class="row"
                                                         style="padding: 16px 0;font-size: 0.9rem">{{ project_discuss.created_time|date:"Y/m/d H:i:s" }}</div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                        <div class="row" style="padding-top: 25px">
                                            <div class="col-md-5">
                                                <div class="form-group row">
                                                    <label class="control-label col-md-2">项目留言</label>
                                                    <div class="col-md-10">
                                            <textarea name="discuss" id="id_discuss" cols="98" rows="4"
                                                      maxlength="200" class="form-control"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-5" style="z-index: -1">
                                                <div class="form-group row">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-5">
                                                <div class="form-group row">
                                                    <label class="control-label col-md-2"></label>
                                                    <div class="col-md-10">
                                                        <input type="file" id="id_file"
                                                               multiple="multiple" onchange="upfile(this)"
                                                               class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-5" style="z-index: -1">
                                                <div class="form-group row">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-actions" style="margin-bottom: 30px">
                                            <button type="submit" class="btn btn-success" href="discuss_end"
                                                    onclick="tab_change(this)">保存
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="tab-pane" id="files" role="tabpanel">
                            <div class="card-body" style="padding: 1.25rem 3.6rem .6rem">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>上传时间</th>
                                        <th>文件名称</th>
                                        <th>上传人</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if files %}
                                        {% for file in files %}
                                            <tr>
                                                <td>{{ file.created_time|date:"Y/m/d H:i" }}</td>
                                                <td>{{ file.name }}</td>
                                                <td>{{ file.created_user }}</td>
                                                <td><a href="/media/{{ file.file }}" download="{{ file.name }}"><span
                                                        class="label label-danger"
                                                        style="background-color:#36d9d1;">下载</span></a></td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="4" style="text-align: center">无记录</td>
                                        </tr>
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'assets/plugins/laydate/laydate.js' %}" type="text/javascript"></script>
    <script>
        var tab = sessionStorage.getItem('tab');
        if (tab) {
            if (tab == '#discuss') {
                $('.tab-pane').removeClass('active');
                $('a.nav-link').removeClass('active');
                $('#discuss').addClass('active show');
                $('a.nav-link[href="#discuss"]').addClass('active show')
            } else if (tab == '#files') {
                $('.tab-pane').removeClass('active');
                $('a.nav-link').removeClass('active');
                $('#files').addClass('active show');
                $('a.nav-link[href="#files"]').addClass('active show')
            } else if (tab == 'discuss_end') {
                $('.tab-pane').removeClass('active');
                $('a.nav-link').removeClass('active');
                $('#discuss').addClass('active show');
                $('a.nav-link[href="#discuss"]').addClass('active show');
                var h = $(document).height();
                $(document).scrollTop(h);
                sessionStorage.setItem('tab', '#discuss');
            } else if (tab == 'record_end') {
                $('.tab-pane').removeClass('active');
                $('a.nav-link').removeClass('active');
                $('#record').addClass('active show');
                $('a.nav-link[href="#record"]').addClass('active show');
                var h = $(document).height();
                $(document).scrollTop(h);
                sessionStorage.setItem('tab', '#record');
            } else if (tab == '#log') {
                $('.tab-pane').removeClass('active');
                $('a.nav-link').removeClass('active');
                $('#log').addClass('active show');
                $('a.nav-link[href="#log"]').addClass('active show')
            }
        } else {
            sessionStorage.setItem('tab', '#record');
        }

        function tab_change(obj) {
            sessionStorage.setItem('tab', $(obj).attr('href'));
        }

        function supen() {
            $('#class').val('supend')
        }

        $('#projects').addClass('active');
        var d = new Date();
        var month = d.getMonth() + 1;
        newdate = d.getFullYear() + "-" + month + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();
        var end_time = '{{ project.end_time|date:"Y-m-d H:i" }}' + ':00';
        laydate.render({
            elem: '#id_record_time'
            , type: 'date'
            , format: 'yyyy-MM-dd'
            , ready: function () {
                var t = $('.layui-laydate').css("top");
                var top = parseInt(t) - 373;
                $('.layui-laydate').css("top", top + "px");
            }
        });
        laydate.render({
            elem: '#id_end_time'
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm'
            , min: newdate
        });
        laydate.render({
            elem: '#id_start_time'
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm'
            , min: newdate
        });
        $('.node').each(function (i, e) {
            mnu = i + 1;
            laydate.render({
                elem: '#id_time' + mnu
                , type: 'datetime'
                , format: 'yyyy-MM-dd HH:mm'
                , min: newdate
            });
            laydate.render({
                elem: '#node_alert_time' + mnu
                , type: 'datetime'
                , format: 'yyyy-MM-dd HH:mm'
                , min: newdate
            });
        });

        function nodes(obj) {
            $.ajax({
                url: "/project/project/api/",
                type: "POST",
                data: {
                    "name": 'node_node',
                    "id": $(obj).val(),
                },
                success: function (data) {
                    if (data) {
                        var node = JSON.parse(data);
                        var node_html = "";
                        for (var i = 0; i < node.length; i++) {
                            var a = "";
                            if ('{{ project.node_node_id }}' == 'None') {
                                if (node[i].fields.num > '{{ project.node_node.num }}') {
                                    a = "<option value='" + node[i].pk + "'>" + node[i].fields.name + "</option>";
                                }
                            } else {
                                a = "<option value='" + node[i].pk + "'>" + node[i].fields.name + "</option>";
                            }
                            node_html += a;
                        }
                        $("select[name='node_node']").find("option").remove();
                        $("select[name='node_node']").append(node_html);
                    }
                }
            });
        }

        function chong() {
            $('.time').show();
            $('#btn1').show();
            $('#btn').hide();
            $('input[name="start_time"]').attr('required', '');
            $('input[name="end_time"]').attr('required', '');
            $('input[name="time"]').attr('required', '');
            $('#class').val('restart');
            if ($('.node').length == 0) {
                $('#project_node').hide();
            }
        }

        function node_file() {
            var files = new Array();
            $('input[name="file"]').each(function () {
                files.push($(this).val())
            });
            $.ajax({
                url: "/project/node/api/",
                type: "POST",
                data: {
                    "file": files,
                    "project_node": $('#id_project_node').val(),
                },
                success: function (data) {
                    window.location.reload()
                }
            });
        }

        function change_node() {
            $('select[name="node"]').attr("required", "");
            $('.no').show();
            $('#btn1').show();
            $('#btn').hide();
            $('#class').val('flow');
            $.ajax({
                url: "/project/project/api/",
                type: "POST",
                data: {
                    "name": 'node',
                    "id": '{{ project.flow_id }}',
                },
                success: function (data) {
                    if (data) {
                        var node = JSON.parse(data);
                        var node_html = "";
                        for (var i = 0; i < node.length; i++) {
                            if (node[i].pk >= {{ project.node_id }}) {
                                var a = "<option value='" + node[i].pk + "'>" + node[i].fields.node_name + "</option>";
                                if (node[i].pk == {{ project.node_id }}) {
                                    a = "<option value='" + node[i].pk + "' selected>" + node[i].fields.node_name + "</option>";
                                }
                                node_html += a;
                            }
                        }
                        $("select[name='node']").find("option").remove();
                        $("select[name='node']").append(node_html);
                        nodes($("select[name='node'] option[selected]"));
                    }
                }
            });
        }
    </script>

{% endblock %}